# Khắc phục lỗi macOS báo phần mềm Malware

## Vấn đề

macOS Gatekeeper phát hiện PHTV là "malware" và tự động xóa vì:

1. ⚠️ **Entitlements nguy hiểm**: App có các quyền runtime nguy hiểm không cần thiết
   - `com.apple.security.cs.allow-jit` (cho phép JIT compilation)
   - `com.apple.security.cs.allow-unsigned-executable-memory` (cho phép execute memory không signed)
   - `com.apple.security.cs.disable-library-validation` (tắt kiểm tra thư viện)

2. ❌ **Thiếu notarization**: App chưa được Apple xác thực (notarize)

3. ⚠️ **Code signing không đầy đủ**: Chỉ ký local, chưa dùng Developer ID

## Giải pháp đã thực hiện

### ✅ 1. Cập nhật Entitlements

File `PHTV/PHTV.entitlements` đã được sửa, **loại bỏ các quyền nguy hiểm**:

**Trước:**
```xml
<dict>
    <key>com.apple.security.cs.allow-jit</key>
    <true/>
    <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
    <true/>
    <key>com.apple.security.cs.disable-library-validation</key>
    <true/>
    <key>com.apple.security.device.input-monitoring</key>
    <true/>
</dict>
```

**Sau:**
```xml
<dict>
    <key>com.apple.security.app-sandbox</key>
    <false/>
    <key>com.apple.security.device.input-monitoring</key>
    <true/>
    <key>com.apple.security.automation.apple-events</key>
    <true/>
</dict>
```

### ✅ 2. Hardened Runtime

Project đã bật Hardened Runtime trong build settings:
- `ENABLE_HARDENED_RUNTIME = YES`
- Loại bỏ tất cả runtime exceptions nguy hiểm

### ✅ 3. Script tự động Code Signing & Notarization

Đã tạo script `scripts/codesign_and_notarize.sh` để:
- Ký code với Developer ID
- Submit lên Apple để notarize
- Staple notarization ticket vào app
- Verify toàn bộ quy trình

## Cách sử dụng

### Bước 1: Chuẩn bị chứng chỉ

1. **Lấy Developer ID Certificate** từ [Apple Developer Portal](https://developer.apple.com/account/resources/certificates/list)
   - Chọn "Certificates, IDs & Profiles"
   - Tạo "Developer ID Application" certificate
   - Download và cài vào Keychain

2. **Tạo App-Specific Password**:
   - Truy cập [appleid.apple.com](https://appleid.apple.com)
   - Vào "Security" > "App-Specific Passwords"
   - Tạo password mới cho notarization

3. **Lưu credentials**:
```bash
export APPLE_ID_EMAIL="your@email.com"
export APPLE_TEAM_ID="YOUR_TEAM_ID"
export APPLE_APP_PASSWORD="xxxx-xxxx-xxxx-xxxx"
```

### Bước 2: Build app

```bash
# Build từ Xcode hoặc command line
xcodebuild -project PHTV.xcodeproj \
    -scheme PHTV \
    -configuration Release \
    -derivedDataPath build \
    clean build
```

### Bước 3: Ký và Notarize

```bash
# Chạy script tự động
./scripts/codesign_and_notarize.sh build/Release/PHTV.app \
    "Developer ID Application: Your Name (TEAMID)"
```

Hoặc với environment variables:

```bash
./scripts/codesign_and_notarize.sh build/Release/PHTV.app
```

### Bước 4: Kiểm tra

```bash
# Verify code signature
codesign -dv --verbose=4 PHTV.app

# Verify notarization
spctl --assess -vv --type install PHTV.app

# Check Gatekeeper
spctl --assess --type execute --verbose=4 PHTV.app
```

## Kết quả mong đợi

✅ **Sau khi hoàn thành:**

1. App được ký với Developer ID
2. App được notarize bởi Apple
3. macOS Gatekeeper **KHÔNG còn** báo malware
4. User có thể cài đặt và chạy bình thường
5. **KHÔNG còn bị tự động xóa**

## Giải thích kỹ thuật

### Tại sao cần loại bỏ các entitlements nguy hiểm?

- **`allow-jit`**: Cho phép runtime code generation - dấu hiệu của malware
- **`allow-unsigned-executable-memory`**: Cho phép execute code từ memory không signed - kỹ thuật code injection
- **`disable-library-validation`**: Tắt kiểm tra thư viện - cho phép load thư viện độc hại

### Tại sao cần notarization?

1. **Gatekeeper Protection**: macOS kiểm tra notarization trước khi cho phép chạy
2. **Malware Detection**: Apple scan malware khi notarize
3. **User Trust**: Hiển thị developer name thay vì "unidentified developer"
4. **Auto Updates**: Sparkle updater cần notarization để hoạt động đúng

### Cấu trúc Hardened Runtime

```
PHTV.app
├── Signed with Developer ID
├── Hardened Runtime enabled
├── Minimal entitlements (chỉ cần thiết)
├── Notarized by Apple
└── Stapled notarization ticket
```

## Troubleshooting

### Lỗi: "no identity found"

```bash
# List available identities
security find-identity -v -p codesigning

# If empty, import certificate from Keychain Access
```

### Lỗi: "notarization failed"

```bash
# Get detailed log
xcrun notarytool log <submission-id> \
    --apple-id "$APPLE_ID_EMAIL" \
    --team-id "$APPLE_TEAM_ID" \
    --password "$APPLE_APP_PASSWORD"
```

### App vẫn bị block

```bash
# Reset Gatekeeper
sudo spctl --master-disable
sudo spctl --master-enable

# Clear quarantine
xattr -cr PHTV.app
```

## CI/CD Integration với GitHub Actions

Workflow đã được cập nhật với notarization tự động! Chỉ cần setup secrets:

### Bước 1: Tạo App-Specific Password

1. Truy cập [appleid.apple.com](https://appleid.apple.com)
2. Vào **Security** > **App-Specific Passwords**
3. Click **Generate an app-specific password**
4. Đặt tên: `GitHub Actions Notarization`
5. Copy password (format: `xxxx-xxxx-xxxx-xxxx`)

### Bước 2: Thêm GitHub Secrets

Vào repository **Settings** > **Secrets and variables** > **Actions**, thêm:

| Secret Name | Value | Mô tả |
|------------|-------|-------|
| `APPLE_ID` | `hungtien10a7@gmail.com` | Apple ID email |
| `APPLE_TEAM_ID` | `F9XPW22T8M` | Team ID từ Developer Portal |
| `APPLE_APP_PASSWORD` | `xxxx-xxxx-xxxx-xxxx` | App-specific password vừa tạo |
| `CERTIFICATES_P12` | Base64 của .p12 file | Developer ID certificate |
| `CERTIFICATE_PASSWORD` | Password của .p12 | Mật khẩu certificate |

### Bước 3: Export Certificate P12

```bash
# Export từ Keychain Access
# 1. Mở Keychain Access
# 2. Tìm "Developer ID Application" certificate
# 3. Right-click > Export
# 4. Lưu thành .p12 với password

# Convert sang base64 cho GitHub Secret
base64 -i ~/Downloads/certificate.p12 | pbcopy
# Paste vào CERTIFICATES_P12 secret
```

### Workflow tự động

Sau khi setup secrets, mỗi lần release workflow sẽ:

1. ✅ Build app với code signing
2. ✅ **Notarize với Apple** (mới thêm!)
3. ✅ Staple notarization ticket
4. ✅ Tạo DMG đã notarized
5. ✅ Sign DMG với Sparkle
6. ✅ Release lên GitHub
7. ✅ Update appcast.xml
8. ✅ Update Homebrew formula

**Kết quả**: Mọi release đều được Apple xác thực, **KHÔNG còn bị cảnh báo malware**!

## Tham khảo

- [Apple Notarization Guide](https://developer.apple.com/documentation/security/notarizing_macos_software_before_distribution)
- [Hardened Runtime](https://developer.apple.com/documentation/security/hardened_runtime)
- [Code Signing Guide](https://developer.apple.com/library/archive/documentation/Security/Conceptual/CodeSigningGuide/)

---

**Lưu ý**: Sau khi apply các thay đổi này, PHTV sẽ **KHÔNG còn** bị macOS cảnh báo là malware.

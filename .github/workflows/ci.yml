name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    name: Build & Regression Tests
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build
        working-directory: App
        run: |
          set -o pipefail
          xcodebuild build \
            -project PHTV.xcodeproj \
            -scheme PHTV \
            -configuration Debug \
            -destination 'platform=macOS' \
            -skipPackagePluginValidation \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            | tee build.log

      - name: Run Engine Regression Tests
        run: |
          set -euo pipefail
          DERIVED_DATA_PATH="${DERIVED_DATA_PATH:-$PWD/.build/derived-data}"
          DESTINATION="${PHTV_TEST_DESTINATION:-platform=macOS}"

          pkill -x PHTV >/dev/null 2>&1 || true

          run_engine_tests() {
            xcodebuild \
              -project App/PHTV.xcodeproj \
              -scheme PHTV \
              -configuration Debug \
              -destination "$DESTINATION" \
              -derivedDataPath "$DERIVED_DATA_PATH" \
              -skipPackagePluginValidation \
              CODE_SIGN_IDENTITY="-" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              DEVELOPMENT_TEAM="" \
              test \
              -only-testing:PHEngineTests/EngineRegressionTests
          }

          attempt=1
          until run_engine_tests; do
            if [ "$attempt" -ge 3 ]; then
              echo "Engine regression tests failed after $attempt attempts"
              exit 1
            fi
            attempt=$((attempt + 1))
            echo "Retrying engine regression tests (attempt $attempt/3)..."
            pkill -x PHTV >/dev/null 2>&1 || true
            sleep 1
          done

          pkill -x PHTV >/dev/null 2>&1 || true

      - name: Run Hotkey Smoke Tests (Clean Defaults)
        run: |
          set -euo pipefail
          DERIVED_DATA_PATH="${DERIVED_DATA_PATH:-$PWD/.build/derived-data}"
          DESTINATION="${PHTV_TEST_DESTINATION:-platform=macOS}"
          DEFAULTS_DOMAIN="com.phamhungtien.phtv"

          pkill -x PHTV >/dev/null 2>&1 || true
          defaults delete "$DEFAULTS_DOMAIN" >/dev/null 2>&1 || true

          run_hotkey_smoke_tests() {
            xcodebuild \
              -project App/PHTV.xcodeproj \
              -scheme PHTV \
              -configuration Debug \
              -destination "$DESTINATION" \
              -derivedDataPath "$DERIVED_DATA_PATH" \
              -skipPackagePluginValidation \
              CODE_SIGN_IDENTITY="-" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              DEVELOPMENT_TEAM="" \
              -parallel-testing-enabled NO \
              test \
              -only-testing:PHEngineTests/HotkeyReliabilityTests
          }

          attempt=1
          until run_hotkey_smoke_tests; do
            if [ "$attempt" -ge 3 ]; then
              echo "Hotkey smoke tests failed after $attempt attempts"
              exit 1
            fi
            attempt=$((attempt + 1))
            echo "Retrying hotkey smoke tests (attempt $attempt/3)..."
            pkill -x PHTV >/dev/null 2>&1 || true
            defaults delete "$DEFAULTS_DOMAIN" >/dev/null 2>&1 || true
            sleep 1
          done

          pkill -x PHTV >/dev/null 2>&1 || true
          defaults delete "$DEFAULTS_DOMAIN" >/dev/null 2>&1 || true

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-build-log
          path: App/build.log
          retention-days: 7
